pipeline{
  	agent {
		docker {
	  		image 'windsekirun/jenkins-android-docker:1.1.1'
		}
 	}
  	options {
		skipStagesAfterUnstable()
  	}
    	stages {
		stage('Prepare') {
	  		steps {
				sh 'chmod +x gradlew && ./gradlew --no-daemon --stacktrace cleanupload Jenkins :app:assembleDevDebugAndroidTest'
	  		}
		}
		stage('Compile') {
	  		steps {
				sh './gradlew compileDebugSources'
	  		}
		}
		stage("Launch Android Emulador") {
        		when {
                		expression { return JOB_PLATFORM_NAME == "android" }
        		}
        		steps {
            			echo "Starting Emulador"
                		// -- First, you need to go to the Emulator Directory.
                		// -- Then launch the Emulator
            			script {
                		try {
                		    sh """
                        		cd ${EMULATOR_DIRECTORY}
                        		./emulator -avd ${JOB_DEVICE_NAME} -engine auto -wipe-data -no-cache -memory 3072 -no-snapshot-save&
                        		sleep 60s
                    			"""
                		} catch (err) { 
                    		echo "The emulator is not open"                                          
      	 			}
            			}      
        	}
    }
					
		
		stage('Unit test') {
			steps{
	  			sh './gradlew --no-daemon --debug :app:connectedDevDebugAndroidTest' 
			}
		}
		stage('Build APK') {
	  		steps {
				sh "./gradlew assembleDebug"
				//sh "./gradlew assembleDebug assembleAndroidTest -PBUILD_NUMBER=${env.BUILD_NUMBER}"
	  		}
		}
	}
}
